<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Knope Chatbot</title>
  <link href="https://fonts.googleapis.com/css2?family=Tinos&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Tinos', serif;
      background-color: #faf9f6;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
    }
    .chat-container {
      margin-top: 0%;
      background-color: white;
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .chat-header {
      background-color: #44c2c2;
      color: white;
      font-weight: bold;
      font-size: 18px;
      padding: 12px;
      display: flex;
      align-items: center;
    }
    .chat-header img { height: 90px; margin-right: 12px; }
    .chat-messages {
      flex: 1; padding: 10px; overflow-y: auto;
      background-color: #ece5dd; display: flex; flex-direction: column;
    }
    .bubble {
      max-width: 75%; padding: 10px 14px; border-radius: 14px;
      margin: 6px 0; word-wrap: break-word; white-space: pre-wrap;
    }
    .user-msg { background-color: #44c2c2; color: white; align-self: flex-end; border-bottom-right-radius: 0; }
    .bot-msg { background-color: white; color: black; align-self: flex-start; border-bottom-left-radius: 0; border: 1px solid #ddd; }
    .chat-input { background-color: #f0f0f0; padding: 10px; border-top: 1px solid #ccc; }
    .chat-input-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    textarea {
      flex: 1 1 300px; resize: none; font-size: 14px; padding: 8px;
      border-radius: 6px; border: 1px solid #ccc;
    }
    .send-btn {
      padding: 8px 16px; background-color: #44c2c2; color: white;
      border: none; border-radius: 6px; font-weight: bold; cursor: pointer;
    }
    .typing { font-style: italic; font-size: 13px; margin: 5px 0; color: gray; }
    #faq-questions { display: none; padding: 0 16px 16px; flex-direction: column; gap: 8px; }
    #faq-questions.open { display: flex; }
    .faq-button {
      background-color: #fff; color: #075e54; border: 1px solid #ccc;
      border-radius: 6px; padding: 8px 12px; cursor: pointer; font-size: 13px; text-align: left;
    }
    .faq-button:hover { background-color: #e0f2f1; }
    .button-container {
      display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;
      padding: 16px; background-color: #faf9f6; box-sizing: border-box;
    }
    .button-container button {
      flex: 1 1 calc(45% - 10px); padding: 10px 20px; background-color: #faf9f6;
      border: 3px solid #ccc; border-radius: 30px; font-size: 14px;
      font-weight: bold; cursor: pointer; text-align: center;
      box-shadow: inset -4px -4px 0 rgba(0, 0, 0, 0.06); min-width: 120px;
    }
    .button-container .uber { border-color: #000000; }
    .button-container .lyft { border-color: #ff00bf; color: black; }
    .button-container .friend { border-color: #44c2c2; color: #44c2c2; }
    .button-container button:hover { opacity: 0.9; }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <img src="nope.png" alt="Knope" />
      Safety Assistant
    </div>
    <div class="chat-messages" id="messages"></div>
    <div class="chat-input">
      <div class="chat-input-row">
        <textarea id="input" rows="1" placeholder="Type a message..."></textarea>
        <button class="send-btn" onclick="sendMessage()">Send</button>
        <button id="faq-toggle" class="send-btn" type="button" aria-expanded="false">Show FAQs</button>
      </div>
    </div>
    <div id="faq-questions"></div>
    <div class="button-container">
      <button onclick="location.href='index.html'">Home</button>
      <button onclick="location.href='report.html'">Report an Incident</button>
      <button class="uber">Call an Uber</button>
      <button class="lyft">Call a Lyft</button>
      <button class="friend">Call Friend</button>
    </div>
  </div>

  <script>
    const supabaseUrl = 'https://sccaeixqffwoziprkkfa.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjY2FlaXhxZmZ3b3ppcHJra2ZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NDU2NTgsImV4cCI6MjA3MzUyMTY1OH0.oD7GduGcCaLvNRmUC_eP3sWJ15Jojm4v-v7sin6va1A';
    const sb = window.supabase.createClient(supabaseUrl, supabaseKey);

    const hiddenPrompt = "Nightlife Safety AssistantEmpowerment-Focused, Patron-SupportiveVersionYou are a conversational AI assistant built into a nightlife safety web app. Your mission is to support patrons in bars, clubs, and party settings to feel empowered, safe, and in controlâ€”especially in moments when something feels off, someone may be unsafe, or a fun night needs a quick safety check-in.You are not a crisis tool, but a calm, trusted support presence that helps people enjoy nightlife with more confidence.ðŸŽ¯ PRIMARY PURPOSE You help users:* Feel safe, supported, and empowered in social settings.* Take quick, discreet actions when something feels wrong.* Trust their instincts and act confidently without fear or judgment.* Know how to spot signs of drink spiking or discomfortâ€”in themselves or others.* Be guided toward clear next steps that protect their safety and autonomyðŸ§  RESPONSE STYLE & BEHAVIOR RULES* Replies must be short (2â€“3 sentences), under 50 words total.* Use a calm, caring, and non-judgmental tone.* Be emotionally responsiveâ€”detect and respond tofear, confusion, urgency, or hesitation.* Always give users agency and clarityâ€”never pressure, shame, or over-explain.* Use natural language, never asterisks or markdown styling.* Never hallucinate or speculate. Stick to facts, safety, and empathy.âœ… SAFETY-FIRST, EMPOWERMENT-ALWAYSA. If a user is in a nightlife setting (e.g., bar, club, party):Encourage them to:1. Check in with themselvesâ€”how theyâ€™re feeling, who theyâ€™re with, and whatâ€™s changed.2. Stay with trusted people or ask for help from venue staff (bartender, bouncer, manager).3. Trust their instinctsâ€”if something feels off, take action.4. If symptoms (confusion, dizziness, memory gaps) arise * Stay in safe company * Ask staff for help* Call emergency services if neededB. If the user is no longer in a nightlife setting (e.g., at home, en route home):Encourage them to:1. Stay with a trusted personâ€”not alone.2. Listen to how their body feelsâ€”don't brush it off.3. Call emergency services if symptoms worsen.4. Know itâ€™s never too late to seek help or clarity.ðŸŒŸ POSITIVE, PROACTIVE SAFETY TOOLSIf the user is not in a crisis, offer supportive tools or reminders to help them stay in control:* Suggest keeping their drink in sight or watching out for friends.* Remind them they can use resources on the homepage* Safe ride home options (Uber/Lyft)* Drink testing info (how to use + interpret kits)* Discreet exit tips or safety plansWhen relevant, direct them to:â€¨Homepage â€“ https://www.knopecover.comâ€¨Education & Support Tools (for those who report being drugged):â€¨https://knomore.org/pages/education-toolsâ€¨Only offer links when clearly appropriate or when the user agrees. Ask first. Offer the link https://sayknope.com for people asking about purchasing anti-drink spiking resources.";

    const messagesDiv = document.getElementById('messages');
    const inputField = document.getElementById('input');

    async function saveMessageToSupabase(message, sender) {
      try {
        const { data, error } = await sb
          .from('input')
          .insert([{ message: `${sender}: ${message}`, created_at: new Date().toISOString() }]);
        if (error) { console.error('Error saving to Supabase:', error); return false; }
        console.log('Message saved to Supabase:', data);
        return true;
      } catch (err) {
        console.error('Exception saving to Supabase:', err);
        return false;
      }
    }

    function appendMessage(content, sender) {
      const bubble = document.createElement('div');
      bubble.className = `bubble ${sender === 'user' ? 'user-msg' : 'bot-msg'}`;
      bubble.textContent = content;
      messagesDiv.appendChild(bubble);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function sendMessage() {
      const text = inputField.value.trim();
      if (!text) return;

      appendMessage(text, 'user');
      inputField.value = '';
      saveMessageToSupabase(text, 'user').catch(console.error);

      fetch('https://knopeprojectfull.onrender.com/log', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user: text })
      }).catch(console.error);

      const typing = document.createElement('div');
      typing.className = 'typing';
      typing.textContent = 'Knope is typing...';
      messagesDiv.appendChild(typing);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      try {
        const response = await fetch('https://knopeprojectfull.onrender.com/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: hiddenPrompt + "\n\n" + text })
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Server error ${response.status}: ${errorText}`);
        }

        const data = await response.json();
        typing.remove();
        const botText = data.response || 'No response.';
        appendMessage(botText, 'bot');
        await saveMessageToSupabase(botText, 'bot');
        fetch('/https://knopeprojectfull.onrender.com/saveMessage', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ user_msg: text, chat_msg: botText })
});

      } catch (err) {
        typing.remove();
        const errMsg = `Error: ${err.message}`;
        appendMessage(errMsg, 'bot');
        await saveMessageToSupabase(errMsg, 'bot');
      }
    }

const predefinedQnA = {
  "What can I do if I think my drink was tampered or drugged?": 
    "If you suspect your drink was tampered or drugged:\n1. Stop Drinking.\n2. Tell a friend, staff member, and/or trusted person outside of the scene.\n3. Get to a position of safety.\n4. Seek medical and/or police assistance.\n5. Consider reporting to police, bar staff, university, or medical personnel.",
  
  "How can I empower myself against drink spiking?": 
    "To empower against drink spiking:\n1. Never leave drinks unattended.\n2. Watch drinks being made, poured, and/or opened.\n3. Use drink tests and/or covers.",
  
  "Where can I access drink-drug tests?": 
    "Drink-drug tests can be available at:\n1. Partnered bars. Ask staff if they have tests on premise.\n2. Partnered student health organizations.\n3. Online sites. Learn more about where to purchase tests at sayknope.com.",
  
  "What symptoms should I look for to identify suspected drink spiking?": 
    "Symptoms of suspected drink spiking can often mimic symptoms of intoxication. Watch for unusual drowsiness, confusion, balance issues, nausea, or feelings of intoxication beyond your norm for the rate of consumption.",
  
  "Can the bar staff help if I suspect that a drink was drugged?": 
    "Partnered bar staff are trained to support against drink spiking. To find partnered bars, go to the home page and click on the \"Find Knope\" button under the \"Knope Tests\" category."
};

    function buildFAQButtonsOnce(container) {
      if (container.dataset.populated === "true") return;
      Object.entries(predefinedQnA).forEach(([question, answer]) => {
        const btn = document.createElement("button");
        btn.textContent = question;
        btn.className = "faq-button";
        btn.onclick = () => {
          appendMessage(question, "user");
          appendMessage(answer, "bot");
          saveMessageToSupabase(question, "user");
          saveMessageToSupabase(answer, "bot");
          saveChatToServer(question);
        };
        container.appendChild(btn);
      });
      container.dataset.populated = "true";
    }

    function toggleFAQ() {
      const faqContainer = document.getElementById("faq-questions");
      buildFAQButtonsOnce(faqContainer);
      faqContainer.classList.toggle("open");
      const isOpen = faqContainer.classList.contains("open");
      const toggleBtn = document.getElementById("faq-toggle");
      toggleBtn.textContent = isOpen ? "Hide FAQs" : "Show FAQs";
      toggleBtn.setAttribute("aria-expanded", String(isOpen));
    }

    function saveChatToServer(text) {
      fetch('https://knopeprojectfull.onrender.com/log', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user: text })
      }).catch(console.error);
    }

    window.onload = () => {
      appendMessage("Hello, my name is Knope. Your safety is our priority. How can I help you today?", "bot");
      const faqToggleBtn = document.getElementById("faq-toggle");
      if (faqToggleBtn) faqToggleBtn.addEventListener("click", toggleFAQ);
    };
  </script>
</body>
</html>







